<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Payments - Developer Example</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://globalpayments-samples.github.io/css/styles.css">
    <style type="text/css">
        .credit-card-card-expiration, .credit-card-card-cvv { margin: 0 !important; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="gp-header">
        <div class="gp-container">
            <div class="gp-header-content">
                <div class="gp-logo">
                    <picture>
                        <source media="(min-width: 768px)" srcset="https://globalpayments-samples.github.io/assets/img/GP_logo.svg">
                        <img src="https://globalpayments-samples.github.io/assets/img/GP_favicon.svg" alt="Global Payments" style="height: 32px; width: auto;">
                    </picture>
                </div>
                <nav class="gp-header-nav">
                    <a href="https://developer.globalpay.com/">Documentation</a>
                    <a href="https://developer.globalpay.com/api">API Reference</a>
                    <a href="https://developer.globalpay.com/sdks">SDKs</a>
                </nav>
            </div>
        </div>
    </header>

    <div class="gp-container">
        <!-- Page Title -->
        <h1 class="gp-page-title">SDK Integration Examples</h1>
        <p class="gp-page-subtitle">Explore comprehensive examples of Global Payments SDK implementations across different payment scenarios.</p>

        <!-- Tabs -->
        <div class="gp-tabs">
            <div class="gp-tab-list">
                <button class="gp-tab-button active" data-tab="payment-form">Payment Form</button>
            </div>

            <!-- Payment Form Tab -->
            <div class="gp-tab-content active" id="payment-form">
                <div class="gp-card">
                    <div class="gp-card-header">
                        <h2 class="gp-card-title">Credit Card Payment Form</h2>
                        <p class="gp-card-description">
                            Secure payment processing using Global Payments tokenization with client-side form validation.
                        </p>
                    </div>

                    <form id="cc-payment-form" class="gp-form" action="/process-payment.php" method="POST">
                        <div class="gp-form-group">
                            <label for="amount" class="gp-label">Amount (€):</label>
                            <input type="number" id="amount" name="amount" class="gp-input" min="0.01" step="0.01" value="10.00" required>
                        </div>
                        
                        <div class="gp-form-group">
                            <label for="billing_zip" class="gp-label">Billing Zip Code:</label>
                            <input type="text" id="billing_zip" name="billing_zip" class="gp-input" placeholder="12345" required>
                        </div>

                        <div class="gp-form-group">
                            <label class="gp-label">Credit Card Information:</label>
                            <div id="credit-card-form"></div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <!-- 
        DEVELOPER NOTE: Update the following footer information to match your business:
        - Company name and copyright year
        - Update all links to point to your actual Terms of Service, Privacy Policy, and Refund Policy pages
        - Refund Policy link is typically required by payment processor underwriting in addition to Terms and Privacy
        - Ensure all linked policies are accessible and up-to-date before going live
    -->
    <footer class="gp-footer">
        <div class="gp-container">
            <div class="gp-footer-content">
                <div class="gp-footer-section">
                    <p class="gp-footer-copyright">
                        © 2024 Your Company Name. All rights reserved.
                    </p>
                </div>
                <div class="gp-footer-section">
                    <nav class="gp-footer-nav">
                        <a href="/terms-of-service" class="gp-footer-link">Terms of Service</a>
                        <a href="/privacy-policy" class="gp-footer-link">Privacy Policy</a>
                        <a href="/refund-policy" class="gp-footer-link">Refund Policy</a>
                    </nav>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://js.globalpay.com/4.1.11/globalpayments.js"></script>
    <script>
        // Global Payments Template JavaScript
        class GPTemplate {
            constructor() {
                this.config = null;
                this.cardForms = {};
                this.init();
            }

            async init() {
                await this.loadConfig();
                await this.initPaymentForms();
            }

            async loadConfig() {
                try {
                    // In a real implementation, this would fetch from your backend
                    // For demo purposes, we'll use a placeholder
                    await ensureGlobalPaymentsReady();
                    const config = await fetchWithRetry('/config.php');
                    
                    if (typeof GlobalPayments !== 'undefined') {
                        GlobalPayments.configure({
                            accessToken: config.data.accessToken,
                            env: "sandbox",
                            fieldValidation: { enabled: true },
                        });
                    }
                } catch (error) {
                    console.error('Failed to load configuration:', error);
                    this.showAlert('error', 'Failed to initialize payment system. Please refresh the page.');
                }
            }

            async initPaymentForms() {
                // Initialize the default active tab
                await this.initCardFormForTab('payment-form');
            }

            async initCardFormForTab(tabId) {
                if (this.cardForms[tabId] || typeof GlobalPayments === 'undefined') {
                    return;
                }

                let containerId;
                switch (tabId) {
                    case 'payment-form':
                        containerId = '#credit-card-form';
                        break;
                    default:
                        return;
                }

                try {
                    const cardForm = GlobalPayments.creditCard.form(containerId, { 
                        style: "gp-default" 
                    });

                    cardForm.on('token-success', (resp) => {
                        this.handleTokenSuccess(resp, tabId);
                    });

                    cardForm.on('token-error', (error) => {
                        this.handleTokenError(error, tabId);
                    });

                    this.cardForms[tabId] = cardForm;

                } catch (error) {
                    console.error(`Failed to initialize card form for ${tabId}:`, error);
                }
            }

            handleTokenSuccess(resp, tabId) {
                const form = document.getElementById(this.getFormIdForTab(tabId));
                this.setLoading(form, false);

                if (tabId === 'tokenization') {
                    // Show token result
                    this.displayToken(resp.paymentReference);
                    this.showAlert('success', 'Card tokenized successfully!');
                } else {
                    // Add token to form and submit
                    this.addTokenToForm(form, resp.paymentReference);
                    
                    // In a real implementation, you would submit to your backend
                    form.submit();
                }
            }

            handleTokenError(error, tabId) {
                const form = document.getElementById(this.getFormIdForTab(tabId));
                this.setLoading(form, false);
                this.showAlert('error', `Error: ${error.message}`);
            }

            getFormIdForTab(tabId) {
                const formMap = {
                    'payment-form': 'cc-payment-form',
                };
                return formMap[tabId];
            }

            addTokenToForm(form, token) {
                // Remove existing token input
                const existingToken = form.querySelector('input[name="payment_token"]');
                if (existingToken) {
                    existingToken.remove();
                }

                // Add new token input
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'payment_token';
                tokenInput.value = token;
                form.appendChild(tokenInput);
            }

            displayToken(token) {
                const tokenResult = document.getElementById('token-result');
                const tokenDisplay = document.getElementById('token-display');
                
                tokenDisplay.textContent = token;
                tokenResult.classList.remove('gp-hidden');
            }

            setLoading(element, isLoading) {
                if (isLoading) {
                    element.classList.add('gp-loading');
                } else {
                    element.classList.remove('gp-loading');
                }
            }

            showAlert(type, message) {
                // Remove existing alerts
                const existingAlerts = document.querySelectorAll('.gp-alert');
                existingAlerts.forEach(alert => {
                    if (!alert.classList.contains('gp-alert-info') || alert.textContent.includes('Info:')) {
                        return; // Keep static info alerts
                    }
                    alert.remove();
                });

                // Create new alert
                const alert = document.createElement('div');
                alert.className = `gp-alert gp-alert-${type}`;
                alert.textContent = message;

                // Insert after the first card header
                const firstCard = document.querySelector('.gp-tab-content.active .gp-card');
                if (firstCard) {
                    const cardHeader = firstCard.querySelector('.gp-card-header');
                    if (cardHeader) {
                        cardHeader.after(alert);
                    }
                }

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }
        }

        // Initialize template when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new GPTemplate();
        });

        // Helper function to ensure GlobalPayments is loaded
        function ensureGlobalPaymentsReady() {
            return new Promise((resolve, reject) => {
                if (typeof GlobalPayments !== 'undefined') {
                    resolve();
                } else {
                    let attempts = 0;
                    const checkInterval = setInterval(() => {
                        attempts++;
                        if (typeof GlobalPayments !== 'undefined') {
                            clearInterval(checkInterval);
                            resolve();
                        } else if (attempts >= 10) {
                            clearInterval(checkInterval);
                            reject(new Error('GlobalPayments failed to initialize'));
                        }
                    }, 500);
                }
            });
        }

        // Fetch with retry logic
        async function fetchWithRetry(url, maxAttempts = 3) {
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (attempt === maxAttempts) throw error;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 100));
                }
            }
        }
    </script>
</body>
</html>